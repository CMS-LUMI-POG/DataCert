# Afterglow
Tools for afterglow corrections

**retrieveBRILData.py**
- the script to retrieve data from brilcalc and store the data in .pkl format.  

- Example usage:
```
python retrieveBRILData.py -f $fill -x --nbxfromhfonly --datadir=/eos/cms/store/group/dpg_bril/comm_bril/lumi/HF_2017_xing
``` 
Here the option --nbxfromhfonly will run the command to retrieve HFOC and HFET data, as defined in line 63-66 [https://github.com/CMS-LUMI-POG/Afterglow/blob/master/retrieveBRILData.py#L63], where you can also change the normtage for the lumi data.  _I couldn't find the way to run brilcalc in the lxplus Condor system, so right now the retrieveBRILData.py script can only be run interactively_.


**makeDataCertTree_BrilbyFill.py**
- The script to produce certification TTrees containing lumi information, the input would be the .pkl files generated by retrieveBRILData.py. 
- Important branches (for HF lumi) in the output TTree include ''fill'', ''run'', ''LS'', ''nActiveBX'', 
''nBXHFET'', ''nBXHFOC'', ''HFETLumi'', ''HFOCLumi'', ''HFETLumi_perBX'', ''HFOCLumi_perBX'', ''HFETBXid'', ''HFOCBXid''.  
- Example usage:
```
python makeDataCertTree_BrilbyFill.py --brilfile=//eos/cms/store/group/dpg_bril/comm_bril/lumi/hfoc_raw_2016/fill5030.pkl --label=5030 --minfill=3818 --outPath=/eos/cms/store/group/dpg_bril/comm_bril/lumi/hfoc_2016_datacert
```
- It is also wrapped in mkAndSubmitCNDJobs.py, which can submit jobs for "makeDataCertTree_BrilbyFill.py" through lxplus Condor system. 

**mkAndSubmitCNDJobs.py**
- The script to submit condor jobs for "makeDataCertTree_BrilbyFill.py".
- Example usage:
```
python mkAndSubmitCNDJobs.py -p /eos/cms/store/group/dpg_bril/comm_bril/lumi/HF_2017_xing -d Test_HF -o /eos/cms/store/group/dpg_bril/comm_bril/lumi/HF_2017_datacert_test -s -c
```

**DeriveHFOC(ET)Corrections_corr_LB.py**
- The script to derive per-BX corrections for HFOC(HFET) luminosity, the input would be the certification TTree produced by "makeDataCertTree_BrilbyFill.py"
- Example usage:
```
python DeriveHFETCorrections_corr_LB.py -f /eos/cms/store/group/dpg_bril/comm_bril/lumi/HF_2018_datacert/dataCertification_320023_320026_6957.root -b --auto  --nLSInLumiBlock=20 -l HFET_2018_corr_fills_6957
```
where the option "--nLSInLumiBlock" specifies the granularity of the correction, i.e. how many lumi sections are combined together into a single lumi block to derive the correction.   The output file contains a set of histograms for each lumi block. The histograms "Before_Corr*" are per-BX luminosities before corrections, while the histograms "After_Corr*" are per-BX luminosities after corrections. 


**mkAndSubCNDDeriveHFOC(ET)Corr_corr_LB.py**
- The script to submit condor jobs for "DeriveHFOC(ET)Corrections_corr_LB.py"
- Example usage:
```
python mkAndSubCNDDeriveHFOCCorr_corr_LB.py -p /eos/cms/store/group/dpg_bril/comm_bril/lumi/HF_2017_datacert -d HF_2017_corr_test --nLSInLumiBlock=50 -l test -c -s 
```

**measureResiduals_HF_LB_byFill.py**
- The script to produce a set of plots for afterglow correction performance (i.e. type 1 and type 2 residuals, etc.), also produces a minitree contains information (type 1, type 2, overall corrections) for each lumi block. Input would be the histogram files generated by "DeriveHFOC(ET)Corrections_corr_LB.py"
- Example usage:
```
python measureResiduals_HF_LB_byFill.py -d HFET_2017_Corr -o HFET_2017_Results_test -l test
```
where "-d" specifies a directory contains multiple input files. If you want to process one specific file, use the "-f" option instead.


**Analysis_Linerity_perFill.py**
- The script to derive effective correction per fill, the input would be the minitree file produced by "measureResiduals_HF_LB_byFill.py"
